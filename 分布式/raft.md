# raft 协议

## raft一致性协议
为什么要用分布式架构？最重要的原因是通过冗余或者副本的方式提高可靠性或者容灾能力。
冗余便会导致一致性问题。所谓的一致性问题就是数据在多个副本中不一致。
那mysql举例，客户端往主库写入x=1，还没来得及同步给从库就挂了，之后将从库选举为主库，x=1这条数据就丢了。
结合cap理论，在分布式架构的前提下，A和C是冲突的。上面的场景如果想追求强一致性也是可以的，比如所有从库同步完才给客户端响应，
以牺牲可用性为代价来换取一致性。这是一种思路。
raft协议就是用来解决上述一致性的协议，其要求数据写入绝大数节点就可以保证一致性，是一种A和C的折中。

## 绝大多数
准确来说，raft要求数据写入集群的半数以上节点，举例：
如果是n=5，要求写入至少3个节点，允许down2个节点
如果是n=6，要求写入至少4个节点，允许down2个节点
从这里可以看出，集群节点是奇数最好， 因为n=5或者6，都能允许2个节点的宕机，那就没必要多一个节点了。

## 节点角色
分布式一致性协议大致氛围两类，集中式的和分布式的。raft协议、zk以及kafka等都是基于集中式的分布式协议。所谓集中式是指集群中有主从概念，写操作交给主节点，从节点只是复制。
raft协议中总共有三种节点：
leader:raft算法是集中式的算法，只有leader可以接收请求
follower:follower负责同步leader节点的日志
candidate:follower和leader之间通过心跳机制保活，如果没有收到心跳，认为leader挂了，会发起选举

## 领导人选举
leader节点需要得到集群中超过半数节点的同意才能当选。
一轮选举中，一个节点只能投一票，所以一轮选举最多只能选出一个leader。
一个节点想要得到选票，其数据必须至少和投票者数据一样新才行，否则，投票者拒绝为其投票。
这一条规则可以保证选举出的leader肯定拥有全部日志。因为最新的日志肯定得写入半数以上节点，假设这个集合是A。
集群中任意一个半数以上的子集肯定包含A至少一个节点，所以leader必然出自A集合。而且A中的节点数据肯定是最新的，包含所有数据。
保证选举出的新leader拥有全部数据是很重要的。

选举发生的时机是什么？
正常情况下，集群中的leader节点会定期给其余节点发送心跳。如果超时未收到心跳，这个节点就会认为leader挂了，从而将自己
变成candidate节点发起一轮选举。每一届leader都有任期term的概念。新一轮选举需要将term自增1。当然，leader挂掉后，可能不止
一个节点变成candidate，所以也就不止一个节点会用下一个term号选举，这样就可能导致选票被分散，选不出leader。然后又重新选举，重新平票。
为了避免这种情况，raft规定每一个节点对leader的超时感知时间是不同的，或者说是随机的，这样就避免了同一时刻多个选举。

## 日志复制
raft协议中，任何操作都以日志的形式被记录下来，并同步给从节点，这种同步形成了状态机。
每一条日志都有一个index号，不断递增。term+index构成了日志的位移标识，也是用来判断日志新旧的标准。
leader节点收到一次写请求，需要将数据日志同步到半数以上节点才能将日志提交并给客户端成功响应。
如果leader没有来得及同步就挂了，刚才的日志就是未提交的，会造成日志冲突，新的leader会强制覆盖。

那新的leader对于自己节点上未提交的日志如何处理？
答案是不做处理，并且在其之后进行追加，并随之后的日志一起提交。这么做是为了防止已提交的日志被覆盖。
如果不这么处理，比如将日志进行同步并且提交，因为这条日志的term号是前任的，所以提交后还是可能被覆盖。所以要求只能提交自己任期内的日志。

## 集群成员变更
集群配置也是以日志方式同步给集群内各个节点的。如果发生集群成员变更，是有可能出现脑裂现象的。比如：
原本集群：A、B、C三个节点。现在要添加两个节点D和E。
由于旧集群中每一个节点配置生效的时间可能是不一样的，可能出现A、D、E是新配置（也即认为集群有5个节点，大多数是3），而B和C是老配置（也即认为集群仍然是3个节点，大多数是2）。
此时如果发生网络分区，A、D、E三个节点是一个分区，然后A得到D和E的选票，达成大多数，A成为leader。B和C 是一个网络分区，B得到C的选票，达成大多数，B成为leader，此时选出了两个leader。
发生这种情况的根本原因是集群中由于配置变更发生时机不一致，导致出现了两个大多数。

那么如何解决？
raft给出了两个方案：

1.一次只添加一个节点。
可以通过穷举法，不论原集群的个数是奇数还是偶数，只添加一个节点，不可能造成两个大多数。
比如原本有5个节点，添加一个后变成6个。majority of old = 3，majority of new = 4。3 + 4 > 6
偶数也是一样的情况。

2.共同一致。
比较难理解。。。TODO

## 小结
raft是一种基于大多数思想的集中式的分布式一致性协议。
核心点有领导人选举、日志复制和集群成员变更。
